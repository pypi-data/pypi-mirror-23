var CSSTransitionGroup=React.addons.CSSTransitionGroup;function isScrolledIntoView(el){if(_.isUndefined(el)){return false;}
var top=el.getBoundingClientRect().top;var bottom=el.getBoundingClientRect().bottom;return(top>=0)&&(bottom<=window.innerHeight);}
var TimelineMessages=React.createClass({displayName:"TimelineMessages",getInitialState:function(){var messages=this.props.messages||[];if(this.props.order==='desc'){messages.reverse();}
return{'messages':this.props.messages||[]};},processMessageLinks:function(){var node=$(ReactDOM.findDOMNode(this));Intercooler.processNodes(node.get(0));var links=node.find('a.confirm');links.confirmation();setupRedirectAfter(links);},showNoMessagesHint:function(){var node=$(ReactDOM.findDOMNode(this));if(this.state.messages.length===0){node.parent().parent().siblings('.timeline-no-messages').show();}else{node.parent().parent().siblings('.timeline-no-messages').hide();}},componentDidMount:function(){this.processMessageLinks();this.showNoMessagesHint();if(this.props.feed!=='static'){var self=this;window.onscroll=_.throttle(function(){if(isScrolledIntoView(self.lastMessageElement())){if(self.props.order==='desc'){self.loadOlder();}else{self.loadNewer();}}},1000);}},lastMessageElement:function(){return $(ReactDOM.findDOMNode(this)).find('li:last').get(0);},componentDidUpdate:function(){this.showNoMessagesHint();},render:function(){var messages=this.state.messages;var showDate=function(ix){if(ix===0){return true;}else{return messages[ix-1].date!==messages[ix].date;}};return(React.createElement(CSSTransitionGroup,{component:"ul",className:"messages",transitionAppear:false,transitionLeave:false,transitionName:"messages",transitionEnterTimeout:500,transitionLeaveTimeout:300},messages.map(function(m,ix){return(React.createElement("li",{key:m.id},showDate(ix)&&React.createElement("div",{className:"date"},React.createElement("span",null,m.date)),React.createElement("div",{className:'message message-'+m.type+' '+(showDate(ix)&&'first-of-day'||''),dangerouslySetInnerHTML:{__html:m.html}})));})));},load:function(direction){var feed=new Url(this.props.feed);var self=this;var messages=this.state.messages;var queuefn=null;if(this.props.order==='desc'){queuefn=direction==='newer'&&'unshift'||'push';}else{queuefn=direction==='newer'&&'push'||'unshift';}
if(messages.length>0){if(direction==='newer'){if(this.props.order==='desc'){feed.query.newer_than=messages[0].id;}else{feed.query.newer_than=messages[messages.length-1].id;}}else{if(this.props.order==='desc'){delete feed.query.newer_than;feed.query.older_than=messages[messages.length-1].id;}else{delete feed.query.newer_than;feed.query.older_than=messages[0].id;}}}
$.getJSON(feed.toString(),function(data){var state=_.extend({},self.state);if(direction==='older'){data.messages.reverse();}
for(var i=0;i<data.messages.length;i++){state.messages[queuefn](data.messages[i]);}
self.setState(state);});},loadOlder:function(){this.load('older');},loadNewer:function(){this.load('newer');}});var Timeline=function(container){var feed=container.data('feed');var messages=container.data('feed-data').messages||[];var order=container.data('feed-order')||'desc';var interval=parseInt(container.data('feed-interval'),10);var el=$('<div>');container.empty();container.append(el);container.timeline=ReactDOM.render(React.createElement(TimelineMessages,{feed:feed,messages:messages,order:order}),el.get(0));if(feed&&interval){setInterval(container.timeline.loadNewer,interval*1000);}};jQuery.fn.timeline=function(){return this.each(function(){Timeline($(this));});};$(document).ready(function(){$('div.timeline').timeline();});