# Benchmarking Suite
# Copyright 2014-2017 Engineering Ingegneria Informatica S.p.A.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
#
# Developed in the ARTIST EU project (www.artist-project.eu) and in the
# CloudPerfect EU project (https://cloudperfect.eu/)

[DEFAULT]
name = YCSB MySQL
class = benchsuite.stdlib.benchmark.vm_benchmark.BashCommandBenchmark

install_centos =
    sudo yum -y install java-1.8.0-openjd mariadb-server mysql-connector-java
    wget https://github.com/brianfrankcooper/YCSB/releases/download/0.12.0/ycsb-jdbc-binding-0.12.0.tar.gz
    tar xzvf ycsb-jdbc-binding-0.12.0.tar.gz
    sudo systemctl start mariadb
    cat >create-table.sql<<END_OF_FILE
	create database benchmark;
	use benchmark;
    CREATE TABLE usertable (
        YCSB_KEY VARCHAR(255) PRIMARY KEY,
        FIELD0 TEXT, FIELD1 TEXT,
        FIELD2 TEXT, FIELD3 TEXT,
        FIELD4 TEXT, FIELD5 TEXT,
        FIELD6 TEXT, FIELD7 TEXT,
        FIELD8 TEXT, FIELD9 TEXT
    );
	END_OF_FILE
	sudo mysql -u root < create-table.sql


execute =
    cd ycsb-jdbc-binding-0.12.0
    bin/ycsb load jdbc -P workloads/workloada -p db.url=jdbc:mysql://127.0.0.1:3306/benchmark -p db.user=root -cp /usr/share/java/mysql-connector-java.jar | tee output
    bin/ycsb run jdbc -P workloads/workloada -p db.url=jdbc:mysql://127.0.0.1:3306/benchmark -p db.user=root -cp /usr/share/java/mysql-connector-java.jar | tee output

    # since the ycsb commands do not exit with an exit status !=0 if the load or run contain errors, we search for the FAILED word in the output
    ! grep FAILED output

workload_name =

[WorkloadA]
workload_name = workloada

[WorkloadB]
workload_name = workloadb

[WorkloadC]
workload_name = workloadc

[WorkloadD]
workload_name = workloadd

[WorkloadE]
workload_name = workloade

[WorkloadF]
workload_name = workloadf

