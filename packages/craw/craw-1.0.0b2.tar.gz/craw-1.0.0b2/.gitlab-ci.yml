stages:
  - test
  - coverage
  - release

variables:
  CRAW_HOME: ${CI_PROJECT_DIR}
  CRAW_VERSION: ${CI_COMMIT_REF_NAME}

testing:
  stage: test
  image: registry-gitlab.pasteur.fr/bneron/craw:centos-run-dep
  script:
    - python3 ${CI_PROJECT_DIR}/tests/run_tests.py -vvv
  except:
    - /^feat.*$/
    - /^fix.*$/

coverage:
  stage: coverage
  image: registry-gitlab.pasteur.fr/bneron/craw:coverage
  script:
    - cd ${CI_PROJECT_DIR}
    - coverage run --source=craw tests/run_tests.py --unit
    - coverage html
    - coverage report
  artifacts:
    paths:
      - htmlcov/
  except:
    - /^feat.*$/
    - /^fix.*$/

pages:
  stage: release
  image: registry-gitlab.pasteur.fr/bneron/craw:release
  dependencies:
    - coverage
  script:
    - cd ${CI_PROJECT_DIR}/doc/
    - make html
    - cd ${CI_PROJECT_DIR}
    - mv ${CI_PROJECT_DIR}/doc/build/html/ public
    - mv htmlcov public/
  artifacts:
    paths:
      - public
  only:
    - master