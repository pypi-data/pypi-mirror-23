<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Servers &#8212; pylm 0.14.1 documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.14.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The PALM message" href="message.html" />
    <link rel="prev" title="High level API" href="high-level.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="message.html" title="The PALM message"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="high-level.html" title="High level API"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pylm 0.14.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="high-level.html" accesskey="U">High level API</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Servers</a><ul>
<li><a class="reference internal" href="#cache">Cache</a></li>
<li><a class="reference internal" href="#scatter-messages-from-the-master-to-the-workers">Scatter messages from the master to the workers</a></li>
<li><a class="reference internal" href="#gather-messages-from-the-workers">Gather messages from the workers</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="high-level.html"
                        title="previous chapter">High level API</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="message.html"
                        title="next chapter">The PALM message</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/servers.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="servers">
<span id="standalone"></span><h1>Servers<a class="headerlink" href="#servers" title="Permalink to this headline">¶</a></h1>
<p>An example of the simplest server was presented in the <a class="reference internal" href="introduction.html#introduction"><span class="std std-ref">Introduction</span></a>. A single server running
in a single process may be useful, but there are a million alternatives to pylm for that. The real usefulness
of pylm arrives when the workload is so large that a single server is not capable of handling it. Here we introduce
parallelism for the first time with the parallel standalone server.</p>
<p>A simple picture of the architecture of a parallel server is presented in the next figure. The client
connects to a master process that manages an arbitrary number of workers. The workers act as slaves, and connect
only to the master.</p>
<div class="figure align-center">
<img alt="_images/parallel.png" src="_images/parallel.png" />
</div>
<p>The following is a simple example on how to configure and run a parallel server. Since the parallel server
is designed to handle a large workload, the job method of the client expects a generator that creates a
series of binary messages.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.servers</span> <span class="kn">import</span> <span class="n">Master</span>


<span class="n">server</span> <span class="o">=</span> <span class="n">Master</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span>
                <span class="n">pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5555&#39;</span><span class="p">,</span>
                <span class="n">pub_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5556&#39;</span><span class="p">,</span>
                <span class="n">worker_pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5557&#39;</span><span class="p">,</span>
                <span class="n">worker_push_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5558&#39;</span><span class="p">,</span>
                <span class="n">db_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.servers</span> <span class="kn">import</span> <span class="n">Worker</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39; processed &#39;</span> <span class="o">+</span> <span class="n">message</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">MyWorker</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.clients</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="s1">&#39;server.foo&#39;</span><span class="p">,</span>
                               <span class="n">repeat</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a message&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                               <span class="n">messages</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The master can be run as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$&gt; python master.py
</pre></div>
</div>
<p>And we can launch two workers as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$&gt; python worker.py worker1
$&gt; python worker.py worker2
</pre></div>
</div>
<p>Finally, here&#8217;s how to run the client and its output:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$&gt; python client.py
b&#39;worker2 processed a message&#39;
b&#39;worker1 processed a message&#39;
b&#39;worker2 processed a message&#39;
b&#39;worker1 processed a message&#39;
b&#39;worker2 processed a message&#39;
b&#39;worker1 processed a message&#39;
b&#39;worker2 processed a message&#39;
b&#39;worker1 processed a message&#39;
b&#39;worker2 processed a message&#39;
b&#39;worker1 processed a message&#39;
</pre></div>
</div>
<p>The communication between the master and the workers is a PUSH-PULL queue of ZeroMQ. This means
that the most likely distribution pattern between the master and the workers follows a round-robin
scheduling.</p>
<p>Again, this simple example shows very little of the capabilities of this pattern in pylm. We&#8217;ll introduce
features step by step creating a manager with more and more capabilities.</p>
<div class="section" id="cache">
<h2>Cache<a class="headerlink" href="#cache" title="Permalink to this headline">¶</a></h2>
<p>One of the services that the master offers is a small key-value database that <strong>can be seen by all the workers</strong>.
You can use that database with RPC-style using <a class="reference internal" href="hl-api-docstrings.html#pylm.clients.Client.set" title="pylm.clients.Client.set"><code class="xref py py-meth docutils literal"><span class="pre">pylm.clients.Client.set()</span></code></a>,
<a class="reference internal" href="hl-api-docstrings.html#pylm.clients.Client.get" title="pylm.clients.Client.get"><code class="xref py py-meth docutils literal"><span class="pre">pylm.clients.Client.get()</span></code></a>, and <a class="reference internal" href="hl-api-docstrings.html#pylm.clients.Client.delete" title="pylm.clients.Client.delete"><code class="xref py py-meth docutils literal"><span class="pre">pylm.clients.Client.delete()</span></code></a> methods.
Like the messages, the data to be stored in the database must be binary.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that the calling convention of <a class="reference internal" href="hl-api-docstrings.html#pylm.clients.Client.set" title="pylm.clients.Client.set"><code class="xref py py-meth docutils literal"><span class="pre">pylm.clients.Client.set()</span></code></a> is not that conventional.
Remember to pass first the value, and then the key if you want to use your own.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">The master stores the data in memory. Have that in mind if you plan to send lots of data to the master.</p>
</div>
<p>The following example is a little modification from the previous example. The client, previously to sending
the job, it sets a value in the temporary cache of the master server. The workers, where the value of the
cached variable is hardcoded within the function that is executed, get the value and they use it to build the
response. The variations respect to the previous examples have been empasized.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.servers</span> <span class="kn">import</span> <span class="n">Master</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Master</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span>
                <span class="n">pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5555&#39;</span><span class="p">,</span>
                <span class="n">pub_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5556&#39;</span><span class="p">,</span>
                <span class="n">worker_pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5557&#39;</span><span class="p">,</span>
                <span class="n">worker_push_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5558&#39;</span><span class="p">,</span>
                <span class="n">db_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.servers</span> <span class="kn">import</span> <span class="n">Worker</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="hll">        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cached&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="n">message</span>
</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">MyWorker</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                  <span class="n">db_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.clients</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; cached data &#39;</span><span class="p">,</span> <span class="s1">&#39;cached&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cached&#39;</span><span class="p">))</span>
    
<span class="hll">    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="s1">&#39;server.foo&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a message&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">messages</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span class="hll">        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>And the output is the following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$&gt; python client.py
b&#39; cached data &#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
</pre></div>
</div>
</div>
<div class="section" id="scatter-messages-from-the-master-to-the-workers">
<h2>Scatter messages from the master to the workers<a class="headerlink" href="#scatter-messages-from-the-master-to-the-workers" title="Permalink to this headline">¶</a></h2>
<p>Master server has a useful method called <a class="reference internal" href="hl-api-docstrings.html#pylm.servers.Master.scatter" title="pylm.servers.Master.scatter"><code class="xref py py-meth docutils literal"><span class="pre">pylm.servers.Master.scatter()</span></code></a>, that
is in fact a generator. For each message that the master gets from the inbound socket, this
generator is executed. It is useful to modify the message stream in any conceivable way. In the
following example, right at the highlighted lines, a new master server overrides this <code class="docutils literal"><span class="pre">scatter</span></code>
generator with a new one that sends the message it gets three times.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.servers</span> <span class="kn">import</span> <span class="n">Master</span>


<span class="hll"><span class="k">class</span> <span class="nc">MyMaster</span><span class="p">(</span><span class="n">Master</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span class="hll">            <span class="k">yield</span> <span class="n">message</span>
</span><span class="hll">
</span><span class="n">server</span> <span class="o">=</span> <span class="n">MyMaster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span>
                  <span class="n">pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5555&#39;</span><span class="p">,</span>
                  <span class="n">pub_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5556&#39;</span><span class="p">,</span>
                  <span class="n">worker_pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5557&#39;</span><span class="p">,</span>
                  <span class="n">worker_push_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5558&#39;</span><span class="p">,</span>
                  <span class="n">db_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>The workers are identical than in the previous example. Since each message that the client sends
to the master is repeated three times, the client expects 30 messages instead of 10.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.clients</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; cached data &#39;</span><span class="p">,</span> <span class="s1">&#39;cached&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cached&#39;</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="s1">&#39;server.foo&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a message&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">messages</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This is the (partially omitted) output of the client:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$&gt; python client.py
b&#39; cached data &#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;

...

b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
</pre></div>
</div>
</div>
<div class="section" id="gather-messages-from-the-workers">
<h2>Gather messages from the workers<a class="headerlink" href="#gather-messages-from-the-workers" title="Permalink to this headline">¶</a></h2>
<p>You can also alter the message stream after the workers have done their job. The master server also includes a
<a class="reference internal" href="hl-api-docstrings.html#pylm.servers.Master.gather" title="pylm.servers.Master.gather"><code class="xref py py-meth docutils literal"><span class="pre">pylm.servers.Master.gather()</span></code></a> method, that is a generator too, that is executed for each message.
Being a generator, this means that gather has to yield, and that the result can be either no message, or an arbitrary
amount of messages. To make this example a little more interesting, we will also disassemble one of these messages that
were apparently just a bunch of bytes.</p>
<p>We will define a gather generator that counts the amount of messages, and when the message number 30 arrives,
the final message, its payload is changed with a different binary string. This means that we need to add an attribute
to the server for the counter, and we have to modify a message with <a class="reference internal" href="hl-api-docstrings.html#pylm.servers.Master.change_payload" title="pylm.servers.Master.change_payload"><code class="xref py py-meth docutils literal"><span class="pre">pylm.servers.Master.change_payload()</span></code></a>.</p>
<p>See that this example is incremental respect to the previous one, and in consequence it uses the cache service and
the scatter and the gather generators.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylm.servers</span> <span class="kn">import</span> <span class="n">Master</span>


<span class="k">class</span> <span class="nc">MyMaster</span><span class="p">(</span><span class="n">Master</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="hll">        <span class="nb">super</span><span class="p">(</span><span class="n">MyMaster</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="hll">    
</span>    <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">gather</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
</span><span class="hll">            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_payload</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;final message&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="k">yield</span> <span class="n">message</span>
</span><span class="hll">
</span><span class="n">server</span> <span class="o">=</span> <span class="n">MyMaster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span>
                  <span class="n">pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5555&#39;</span><span class="p">,</span>
                  <span class="n">pub_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5556&#39;</span><span class="p">,</span>
                  <span class="n">worker_pull_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5557&#39;</span><span class="p">,</span>
                  <span class="n">worker_push_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5558&#39;</span><span class="p">,</span>
                  <span class="n">db_address</span><span class="o">=</span><span class="s1">&#39;tcp://127.0.0.1:5559&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-default"><div class="highlight"><pre><span></span>$&gt; python client.py
b&#39; cached data &#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker2 cached data a message&#39;

...

b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;worker2 cached data a message&#39;
b&#39;worker1 cached data a message&#39;
b&#39;Final message&#39;
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="message.html" title="The PALM message"
             >next</a> |</li>
        <li class="right" >
          <a href="high-level.html" title="High level API"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pylm 0.14.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="high-level.html" >High level API</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015-2016, Guillem Borrell &amp; NFQ Solutions.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>